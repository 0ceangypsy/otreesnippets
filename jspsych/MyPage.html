{{ block content }}

  {#
  This template is based on https://www.jspsych.org/tutorials/rt-task/,
  with some extra comments like these to explain how it was integrated into oTree.

  jspsych is loaded into this element. If this is omitted, jspsych will take up the whole page.
  #}
  <div id="jspsych-target"></div>

  {#
  This is the hidden input used to pass data back to oTree. See here:
  https://otree.readthedocs.io/en/latest/forms.html#raw-html-example-custom-user-interface-with-javascript
  #}

  <input id="avg_reaction" name="avg_reaction" type="hidden">
  <input id="jspsych_raw" name="jspsych_raw" type="hidden">

  <script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.1.0/jspsych.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.1.0/plugins/jspsych-html-keyboard-response.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  <script>

      var timeline = [];

      var welcome = {
          type: "html-keyboard-response",
          stimulus: "Welcome to the experiment. Press any key to begin."
      };
      timeline.push(welcome);

      // oTree needs to use the 'static' tag to get images.
      var bluepng = "{{ static 'jspsych_example/blue.png' }}";
      var orangepng = "{{ static 'jspsych_example/orange.png' }}";

      var instructions = {
          type: "html-keyboard-response",
          stimulus: "<p>In this experiment, a circle will appear in the center " +
              "of the screen.</p><p>If the circle is <strong>blue</strong>, " +
              "press the letter F on the keyboard as fast as you can.</p>" +
              "<p>If the circle is <strong>orange</strong>, press the letter J " +
              "as fast as you can.</p>" +
              "<div style='width: 700px;'>" +
              "<div style='float: left;'><img src='" + bluepng + "'></img>" +
              "<p class='small'><strong>Press the F key</strong></p></div>" +
              "<div class='float: right;'><img src='" + orangepng + "'></img>" +
              "<p class='small'><strong>Press the J key</strong></p></div>" +
              "</div>" +
              "<p>Press any key to begin.</p>",
          post_trial_gap: 2000
      };
      timeline.push(instructions);

      var test_stimuli = [
          {stimulus: bluepng, data: {test_part: 'test', correct_response: 'f'}},
          {stimulus: orangepng, data: {test_part: 'test', correct_response: 'j'}}
      ];

      var fixation = {
          type: 'html-keyboard-response',
          stimulus: '<div style="font-size:60px;">+</div>',
          choices: jsPsych.NO_KEYS,
          trial_duration: function () {
              return jsPsych.randomization.sampleWithoutReplacement([250, 500, 750, 1000, 1250, 1500, 1750, 2000], 1)[0];
          },
          data: {test_part: 'fixation'}
      }

      var test = {
          type: "image-keyboard-response",
          stimulus: jsPsych.timelineVariable('stimulus'),
          choices: ['f', 'j'],
          data: jsPsych.timelineVariable('data'),
          on_finish: function (data) {
              data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
          },
      }

      var test_procedure = {
          timeline: [fixation, test],
          timeline_variables: test_stimuli,
          repetitions: 5,
          randomize_order: true
      }
      timeline.push(test_procedure);

      var debrief_block = {
          type: "html-keyboard-response",
          stimulus: function () {

              var trials = jsPsych.data.get().filter({test_part: 'test'});
              var correct_trials = trials.filter({correct: true});
              var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
              var rt = Math.round(correct_trials.select('rt').mean());

              return "<p>You responded correctly on " + accuracy + "% of the trials.</p>" +
                  "<p>Your average response time was " + rt + "ms.</p>" +
                  "<p>Press any key to complete the experiment. Thank you!</p>";

          }
      };
      timeline.push(debrief_block);

      jsPsych.init({
          timeline: timeline,
          display_element: 'jspsych-target',
          on_finish: function () {
              /*
              Here we get whatever data we want using jsPsych.data. See here:
              https://www.jspsych.org/core_library/jspsych-data/
              This example shows how to store (1) the raw data of each response
              and (2) a summary statistic, like average response time.
              */
              let allData = jsPsych.data.get().filter({trial_type: 'image-keyboard-response'});
              document.getElementById('jspsych_raw').value = JSON.stringify(allData.json());

              let avg = allData.select('rt').mean();
              document.getElementById('avg_reaction').value = Math.round(avg);

              // automatically submit the file to the server
              document.getElementById('form').submit();
          }
      });
  </script>

{{ endblock }}
